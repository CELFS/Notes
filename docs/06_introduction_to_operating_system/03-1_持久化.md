### 03 持久性

Date：2023/06/11 16:33:27

------



[TOC]



------



### 第35章 关于持久性的对话

* 摘录
  * 持久的传统含义：“尽管遇到困难或反对，但在行动过程中坚定或顽固地继续下去。”
  * 你拿了很多很多的桃子，但是你想让它们持久保持很长时间。
  * 信息也是如此。让信息持久，尽管计算机会崩溃，磁盘会出故障或停电，这是一项艰巨而有趣的挑战。
  * 持久保持（persist）



------



### 第36章 I/O设备

* 关键问题：如何将I/O集成进计算机系统中

  * 输入/输入（I/O）设备、交互

* 系统架构

  * 典型系统架构、内存总线（memory bus）/ 互连电缆、I/O总线（I/O bus）、外围总线（peripheral bus，如 SCSI、SATA、USB，最慢）
  * 分层架构：因为物理布局及造价成本。越快的总线越短，因此高性能的内存总线没有足够的空间连接太多设备。

  ![img](images/03-1_持久化/epub_30179184_142.jfif)

* 标准设备

  * 硬件接口（interface）、特定接口+典型交互协议、内部结构（internal structure）、现代 RAID 控制器、固件（firmware 硬件设备中的软件）

  ![img](images/03-1_持久化/epub_30179184_143.jfif)

* 标准协议

  * 状态寄存器、命令寄存器、数据寄存器、轮询（polling）设备、编程的I/O（programmed I/O，PIO）
  * 优缺：足够简单、有效，难免低效、不方便
  * 关键问题：如何减少轮询开销

* 利用中断减少 CPU 开销

  * 中断（interrupt）、中断服务例程（Interrupt Service Routine，ISR）/ 中断处理程序（interrupt handler，结束请求、唤醒等待）、混合（hybrid）策略、两阶段（two-phased）、“点杠效应”、合并（coalescing）
  * 核心：中断允许计算与I/O重叠，是提高CPU利用率的关键。此时，操作系统可以在等待磁盘操作时做其他事情。
  * 中断并非总是最佳方案：如果设备非常快，那么最好的办法反而是轮询。如果设备比较慢，那么采用允许发生重叠的中断更好（仅在慢速设备中断重叠有效）

* 利用 DMA 进行更高效的数据传送

  * 关键问题：如何减少 PIO 的开销
  * DMA 引擎（Direct Memory Access）、DMA控制器
    * 拷贝内存位置、拷贝大小、拷贝目的地

  ![img](images/03-1_持久化/epub_30179184_147.jfif)

* 设备交互的方法

  * 关键问题：如何与设备通信
  * 两种方式
    * （1）用明确的 I/O 指令（特权指令，privileged）；
    * （2）内存映射 I/O（memory- mapped I/O），硬件将设备寄存器作为内存地址提供。

* 纳入操作系统：设备驱动程序

  * 关键问题：如何实现一个设备无关的操作系统
  * SCSI硬盘、IDE硬盘、USB钥匙串设备、抽象（abstraction）、设备驱动程序（device driver）、设备无关、Linux 文件系统栈、通用接口、报告错误信息

  ![img](images/03-1_持久化/epub_30179184_148.jfif)

* 案例研究：简单的 IDE 磁盘驱动程序

  * IDE 磁盘驱动程序、xv6源码、xv6的 IDE 驱动程序
  * 四种寄存器：控制、命令块、状态和错误
  * 与设备交互的简单协议
    * **等待驱动就绪**。读取状态寄存器（0x1F7）直到驱动READY而非忙碌。
    * **向命令寄存器写入参数**。写入扇区数，待访问扇区对应的逻辑块地址（LBA），并将驱动编号（master=0x00，slave=0x10，因为IDE允许接入两个硬盘）写入命令寄存器（0x1F2-0x1F6）。● 开启I/O。发送读写命令到命令寄存器。向命令寄存器（0x1F7）中写入READ-WRITE 命令。
    * **数据传送（针对写请求）**：等待直到驱动状态为READY和DRQ（驱动请求数据），向数据端口写入数据。
    * **中断处理**。在最简单的情况下，每个扇区的数据传送结束后都会触发一次中断处理程序。较复杂的方式支持批处理，全部数据传送结束后才会触发一次中断处理。
    * **错误处理**。在每次操作之后读取状态寄存器。如果ERROR位被置位，可以读取错误寄存器来获取详细信息。

* 历史记录

  * 基本思想的由来、中断向量、DRAM、虚拟化、缓存优化算法、Web 服务器网络性能
  * 中断、DMA 及相关思想都是在快速 CPU 和慢速设备之间权衡的结果。



2023/06/12 21:14:19

------



### 第37章 磁盘驱动器

* 关键问题：如何存储和访问磁盘上的数据
  
  * 磁盘驱动器（hard disk drive）、文件系统技术、持久数据存储、磁盘操作细节
  
* 接口
  
  * 扇区、地址空间（address space）、多扇区操作、单扇区原子写入、掉电、不完整写入（torn write）、读写假设、连续块、“不成文合同”
  
* 基本几何形状
  
  * 盘片（platter）、磁性变化、表面、磁性层、主轴（spindle）、恒定速度、每分钟转数（Rotations Per Minute，RPM）、单次旋转时间、磁头（disk head）、磁盘臂（disk arm）
  
* 简单的磁盘驱动器

  * 最昂贵：寻道、旋转
  * 单磁道延迟：旋转延迟
    * I/O 服务时间、旋转延迟（rotational delay  / rotation delay）
  * 多磁道：寻道时间
    * 寻道（seek）、停放时间（settling time）、传输（transfer）
    * 完整的I/O时间图：首先寻道，然后等待转动延迟，最后传输。
  * 一些其他细节
    * 磁道偏斜（track skew）、重新定位磁头、几何结构的结果、多区域（multi-zoned）磁盘驱动器、缓存（cache）/ 磁道缓冲区（track buffer）
    * 它应该在将数据**放入其内存之后**，还是写入**实际写入磁盘之后**，回报写入完成？
      * 后写缓存（write back） / 立即报告（immediate reporting）
      * 直写（write through）
    * 量纲分析（dimensional analysis，确保在可能的情况下消掉单位）、计算机系统分析、每分钟的旋转次数（rotations per minute）、I/O 分析

* I/O 时间：用数学

  * I/O 速率（RI/O）、随机（random）工作负载、顺序（sequential）工作负载、Cheetah 15K.5（高性能SCSI驱动器）、Barracuda（为容量而生的驱动器）

  ![img](images/03-1_持久化/epub_30179184_160.jfif)

  * 大块传输、平均寻道时间、完全寻道、RPS（每秒转速）、驱动性能差距

  ![img](images/03-1_持久化/epub_30179184_161.jfif)

  * 计算“平均”寻道时间、平均搜索距离、分离绝对值、内层积分、寻道总数

* 磁盘调度

  * 任务调度、任务长度
    * 猜测“任务”（即磁盘请求）需要多长时间（估计）
    * SJF（最短任务优先）原则（principle of SJF，shortest job first）
  * SSTF：最短寻道时间优先
    * 最短寻道时间优先（Shortest-Seek-Time-First，SSTF / 最短寻道优先 Shortest-Seek-First，SSF）、最近块优先（Nearest-Block-First，NBF）、饥饿（starvation）
    * 关键问题：如何处理磁盘饥饿
  * 电梯（又称SCAN或C-SCAN）
    * SCAN（忽视旋转）、扫一遍、变种、F-SCAN、C-SCAN（Circular SCAN）、电梯（elevator）算法
    * 关键问题：如何计算磁盘旋转开销
  * SPTF：最短定位时间优先
    * 最短定位时间优先调度（Shortest Positioning Time First，SPTF / 最短接入时间优先 Shortest Access Time First，SATF）、**“视情况而定”**、相对时间、总是视情况而定（LIVNY定律，谨慎使用）
  * 其他调度问题
    * 在现代系统上执行磁盘调度的地方在哪里？
      * 多个分离请求、磁盘控制器、复杂内部调度程序
      * I/O合并（I/O merging）
    * 在向磁盘发出I/O之前，系统应该等待多久？
      * 工作保全（work-conserving）、非工作保全（non-work-conserving）

* 疑问 / 感悟

  * 双重求和即二重积分的计算方式，绝对值积分的拆分方式遗忘，需回顾以前写的讲义，用更简练的语言进行信息复原。

* 摘录

  * 在工程中，事实证明“视情况而定”几乎总是答案，这反映了取舍是工程师生活的一部分。然而，知道为什么视情况而定总是更好的。
  * 在现代驱动器中，查找和旋转大致相当（当然，视具体的请求而定），因此SPTF是有用的，它提高了性能。然而，它在操作系统中实现起来更加困难，操作系统通常不太清楚磁道边界在哪，也不知道磁头当前的位置（旋转到了哪里）。
  * 详细的功能模型、物理、电子和材料科学、磁盘调度领域、“等待” 改善磁盘调度、MEMS



2023/06/15 22:35:25

------



### 第38章 廉价冗余磁盘阵列（RAID）

* 关键问题：如何得到大型、快速、可靠的磁盘
* 接口和RAID内部
* 故障模型
* 如何评估RAID
* RAID 0级：条带化
  * 大块大小
  * 回到RAID-0分析
  * 评估RAID性能
  * 再次回到RAID-0分析
* RAID 1级：镜像
  * RAID-1分析
* RAID 4级：通过奇偶校验节省空间
  * RAID-4分析
* RAID 5级：旋转奇偶校验
  * RAID-5分析
* RAID比较：总结
* 其他有趣的RAID问题



------



### 第39章 插叙：文件和目录

* 关键问题：如何管理持久存储设备
* 文件和目录
* 文件系统接口
* 创建文件
* 读写文件
* 读取和写入，但不按顺序
* 用fsync()立即写入
* 文件重命名
* 获取文件信息
* 删除文件
* 创建目录
* 读取目录
* 删除目录
* 硬链接
* 符号链接
* 创建并挂载文件系统



------



### 第40章 文件系统实现

* 关键问题：如何实现简单的文件系统
* 思考方式
* 整体组织
* 文件组织：inode
  * 多级索引
* 目录组织
* 空闲空间管理
* 访问路径：读取和写入
  * 从磁盘读取文件
  * 写入磁盘
  * 关键问题：如何降低文件系统I/O成本
* 缓存和缓冲



------



### 第41章 局部性和快速文件系统

* 问题：性能不佳
  * 关键问题：如何组织磁盘数据以提高性能
* FFS：磁盘意识是解决方案
* 组织结构：柱面组
* 策略：如何分配文件和目录
* 测量文件的局部性
* 大文件例外
* 关于FFS的其他几件事



------



### 第42章 崩溃一致性：FSCK和日志

* 关键问题：考虑到崩溃，如何更新磁盘
* 一个详细的例子
  * 崩溃场景
  * 崩溃一致性问题
* 解决方案1：文件系统检查程序
* 解决方案2：日志（或预写日志）
  * 数据日志
  * 恢复
  * 批处理日志更新
  * 使日志有限
  * 元数据日志
  * 棘手的情况：块复用
  * 总结日志：时间线
* 解决方案3：其他方法



------



### 第43章 日志结构文件系统

* 关键问题：如何让所有写入变成顺序写入？
* 按顺序写入磁盘
* 顺序而高效地写入
* 要缓冲多少
* 问题：查找inode
* 通过间接解决方案：inode映射
* 检查点区域
* 从磁盘读取文件：回顾
* 目录如何
* 一个新问题：垃圾收集
* 确定块的死活
* 策略问题：要清理哪些块，何时清理
* 崩溃恢复和日志



------



### 第44章 数据完整性和保护

* 关键问题：如何确保数据完整性
* 磁盘故障模式
* 处理潜在的扇区错误
  * 关键问题：如何处理潜在的扇区错误
* 检测讹误：校验和
  * 关键问题：尽管有讹误，如何保护数据完整性
  * 常见的校验和函数
  * 校验和布局
* 使用校验和
* 一个新问题：错误的写入
  * 关键问题：如何处理错误的写入
* 最后一个问题：丢失的写入
  * 关键问题：如何处理丢失的写入
* 擦净
* 校验和的开销



------



### 第45章 关于持久的总结对话

* 



------



### 第46章 关于分布式的对话

* 



------



### 第47章 分布式系统

* 



------



### 第48章 Sun的网络文件系统（NFS）

* 



------



### 第49章 Andrew文件系统（AFS）

* 



------



### 第50章 关于分布式的总结对话

* 



------

